sudo: required
language: ruby
rvm: 2.4.0
os: linux
env:
  global: 
    - DOCKER_USERNAME=kenman345
    - BUILD_DOCKER=false
    - NEXT_BUILD_TAG=latest
    - NOKOGIRI_USE_SYSTEM_LIBRARIES=true
    - secure: C7mCh9Pl4mxH/YtnjhMueSTyulbQdADfw2LCsPCwxwT30Ic/DTj3if12y0QItDnW7fwwR83Y+vZsLUYDyrwMRAFbi8pR2nZN74Ri2CWAviynxQ2Z/dEh73Gss6eCw617eMAI5OGAZ2809vXE6zwag9j6sIksvAA7bd/n2DRSNXwOrBTs7Y+Q5J3MP4bUs2hQ65PkEbIIbHWC7wCSY4t3KAp8q7v0DMxDuKdxExRE61RlsYe2A+fBsAHepXeCXIvzCmxTxaiYRKRV1VZi6jJtFI9QB6HmKBNC/QuQZcJRptmDEY22/u+AtN8kpViDZzq26fy6uD5GYDuYWipwsrVhUSi5IakL01jzG1nDIq/Q+U0OzES9oow+2FEzyjMS/faP/I0shPDmyHwecZHimlg7ue0cVJIpwCocqXfkcY3ShmcWA3qih64uFTetSjtP3UJrpAUo+rfGktAH51dzxqmEY+I6TmfA6t7p0ztURFoR/dRENbIw7ouTcmRyWl6y/OxHnki6g3X3kxZPZZmQbMi0y6OmkKDtefGaJdvM1clGhqwlxOPs3yIGSG7jBCKe4cLzWT7TOwkO3GDaW9rTrgHaYTjq+HUkIrkU2ZEJLMN4ufuwSFJ4l+VvwFmi7buiiV1vSR+29kasGFdUNcAeuuZhsliD9AzK23+HNB1wTm12JtM=
python:
  - "3.4"
services:
  - docker
cache:
  bundler: true
  directories: $TRAVIS_BUILD_DIR/tmp/.htmlproofer
addons:
  apt:
    packages:
    - libcurl4-openssl-dev
    - ca-certificates
before_install: 
    - gem update --system --no-doc
    - bundle install --gemfile=Gemfile
    - pip install --user pathlib
stages: 
    - test
    - verify
    - name: deploy
      if: branch = master
matrix:
  fast_finish: true
  include:
    - stage: deploy
      script:
      - BUILD_DOCKER="true"
      - if [ "$TRAVIS_TAG" != "" ]; then NEXT_BUILD_TAG=`date +"%m-%d-%Y"`; BUILD_DOCKER="true"; fi
      - NEXT_BUILD_TAG=`date +"%m-%d-%Y"`
      - echo ".git" > .dockerignore
      - bundle exec rake docker:build
      - if [ "$NEXT_BUILD_TAG" != "latest" ]; then docker tag kenman345/acceptbitcoincashdocker kenman345/acceptbitcoincashdocker:"$NEXT_BUILD_TAG"; fi
      #- if [ "$NEXT_BUILD_TAG" != "" ]; then sh ./scripts/bash/build.sh; fi
      #- if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then 
      # - if [ "$NEXT_BUILD_TAG" != "false" ]; then 
        # git config credential.helper "store --file=.git/credentials"; 
        # echo "https://$GITHUB_TOKEN:@github.com" > .git/credentials; 
        # git commit -m 'Updates site count [skip ci]' ./_includes/count_support.html;
        # git remote -v;
        # git remote set-url origin https://github.com/$TRAVIS_REPO_SLUG.git;
        # git push origin HEAD:$TRAVIS_BRANCH;
        # fi    
        #git push origin HEAD:master;
    - stage: verify
      script:
      - bundle exec rake verify_images
      - bundle exec rake proof
    - script: 
      - bundle exec rake proof_external
    - stage: test
      script: 
      - bundle exec rake proof_external
  allow_failures:
    - script: 
      - bundle exec rake verify_images
      - bundle exec rake proof
    - script: 
      - bundle exec rake proof_external
#before_deploy:
#  - script: 
#    - docker tag kenman345/acceptbitcoincashdocker kenman345/acceptbitcoincashdocker:"$NEXT_BUILD_TAG"
deploy:
  - provider: pages
    skip-cleanup: true
    github-token: $GITHUB_TOKEN  # Set in travis-ci.org dashboard, marked secure
    keep-history: true
    on: 
      branch: master
      #tags: true
      condition: $BUILD_DOCKER == "true"
  - provider: script
    skip-cleanup: true
    script:
    #- docker tag kenman345/acceptbitcoincashdocker kenman345/acceptbitcoincashdocker:"$NEXT_BUILD_TAG"
    #- docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"; docker push kenman345/acceptbitcoincashdocker
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin; docker push kenman345/acceptbitcoincashdocker
    on: 
      branch: master
      condition: $BUILD_DOCKER == "true"