sudo: required
language: ruby
rvm: 2.4.0
os: linux
env:
  global: 
    - DOCKER_USERNAME=kenman345
    - NOKOGIRI_USE_SYSTEM_LIBRARIES=true
    - secure: C7mCh9Pl4mxH/YtnjhMueSTyulbQdADfw2LCsPCwxwT30Ic/DTj3if12y0QItDnW7fwwR83Y+vZsLUYDyrwMRAFbi8pR2nZN74Ri2CWAviynxQ2Z/dEh73Gss6eCw617eMAI5OGAZ2809vXE6zwag9j6sIksvAA7bd/n2DRSNXwOrBTs7Y+Q5J3MP4bUs2hQ65PkEbIIbHWC7wCSY4t3KAp8q7v0DMxDuKdxExRE61RlsYe2A+fBsAHepXeCXIvzCmxTxaiYRKRV1VZi6jJtFI9QB6HmKBNC/QuQZcJRptmDEY22/u+AtN8kpViDZzq26fy6uD5GYDuYWipwsrVhUSi5IakL01jzG1nDIq/Q+U0OzES9oow+2FEzyjMS/faP/I0shPDmyHwecZHimlg7ue0cVJIpwCocqXfkcY3ShmcWA3qih64uFTetSjtP3UJrpAUo+rfGktAH51dzxqmEY+I6TmfA6t7p0ztURFoR/dRENbIw7ouTcmRyWl6y/OxHnki6g3X3kxZPZZmQbMi0y6OmkKDtefGaJdvM1clGhqwlxOPs3yIGSG7jBCKe4cLzWT7TOwkO3GDaW9rTrgHaYTjq+HUkIrkU2ZEJLMN4ufuwSFJ4l+VvwFmi7buiiV1vSR+29kasGFdUNcAeuuZhsliD9AzK23+HNB1wTm12JtM=
python:
  - "3.4"
services:
  - docker
cache:
  bundler: true
  directories: $TRAVIS_BUILD_DIR/tmp/.htmlproofer
addons:
  apt:
    packages:
    - libcurl4-openssl-dev
    - ca-certificates
before_install: 
    - gem update --system --no-doc
    - bundle install --gemfile=Gemfile
    - pip install --user pathlib
matrix:
  fast_finish: true
  include:
    - env: 
      - build_docker=true
      - NEXT_BUILD_TAG=test
      script:
      - echo "$NEXT_BUILD_TAG"
      - NEXT_BUILD_TAG="tester"
      - echo "$NEXT_BUILD_TAG"
      - if [ "$TRAVIS_TAG" != "" ]; then NEXT_BUILD_TAG="$TRAVIS_TAG"; fi
      - if [ "$NEXT_BUILD_TAG" != "" ]; then rake docker:build "$NEXT_BUILD_TAG"; fi
      #- echo "$TRAVIS_PULL_REQUEST"
      # - if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then 
        # git commit -m 'Updates site count' ./_includes/count_support.html;
        # git push origin HEAD:master;
        # fi
    - script:
      - bundle exec rake verify_images
      - bundle exec rake proof_external
  allow_failures:
    - script: 
      - bundle exec rake verify_images
      - bundle exec rake proof_external
#after_success:
#  - if [ "$TRAVIS_BRANCH" == "master" ]; then
#      if [ "$build_docker" == "true" ]; then
#        docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD";
#        docker push kenman345/acceptbitcoincashdocker;
#      fi
#    fi
deploy:
  - provider: pages
    skip-cleanup: true
    github-token: $GITHUB_TOKEN  # Set in travis-ci.org dashboard, marked secure
    keep-history: true
    on: 
      branch: master
      condition: $build_docker
  - provider: script
    skip-cleanup: true
    script:
    - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"; docker push kenman345/acceptbitcoincashdocker
    on: 
      branch: master
      #tags: true
      condition: $build_docker